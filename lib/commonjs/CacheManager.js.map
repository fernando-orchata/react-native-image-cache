{"version":3,"sources":["CacheManager.ts"],"names":["CacheEntry","constructor","source","options","cacheKey","getPath","path","exists","tmpPath","getCacheEntry","downloadPromise","pathResolved","download","result","FileSystem","fetch","status","undefined","mv","CacheManager","config","defaultConfig","newConfig","get","entries","clearCache","files","ls","baseDir","file","unlink","e","console","log","removeCacheEntry","entry","Error","getCacheSize","stat","size","defaultConfiguration","filename","substring","lastIndexOf","indexOf","length","ext","sha","mkdir"],"mappings":"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","sourcesContent":["// @ts-ignore\nimport SHA1 from 'crypto-js/sha1';\nimport uniqueId from 'lodash/uniqueId';\nimport { FileSystem } from 'react-native-file-access';\n\nimport { Config, DownloadOptions } from './types';\nimport defaultConfiguration from './defaultConfiguration';\n\nexport class CacheEntry {\n  source: string;\n\n  options: DownloadOptions;\n\n  cacheKey: string;\n\n  downloadPromise: Promise<string | undefined> | undefined;\n\n  pathResolved = false;\n\n  constructor(source: string, options: DownloadOptions, cacheKey: string) {\n    this.source = source;\n    this.options = options;\n    this.cacheKey = cacheKey;\n  }\n\n  async getPath(): Promise<string | undefined> {\n    const { cacheKey } = this;\n    const { path, exists, tmpPath } = await getCacheEntry(cacheKey);\n    if (exists) {\n      return path;\n    }\n\n    if (!this.downloadPromise) {\n      this.pathResolved = false;\n      this.downloadPromise = this.download(path, tmpPath);\n    }\n\n    if (this.downloadPromise && this.pathResolved) {\n      this.pathResolved = false;\n      this.downloadPromise = this.download(path, tmpPath);\n    }\n    return this.downloadPromise;\n  }\n\n  private async download(\n    path: string,\n    tmpPath: string\n  ): Promise<string | undefined> {\n    const { source, options } = this;\n    if (source != null) {\n      const result = await FileSystem.fetch(source, {\n        path: tmpPath,\n        ...options,\n      });\n      // If the image download failed, we don't cache anything\n      if (result && result.status !== 200) {\n        this.downloadPromise = undefined;\n        return undefined;\n      }\n      await FileSystem.mv(tmpPath, path);\n      this.pathResolved = true;\n      return path;\n    }\n    return source;\n  }\n}\n\nexport default class CacheManager {\n  static defaultConfig: Config = defaultConfiguration;\n  static config: Config;\n\n  get config() {\n    return CacheManager.defaultConfig;\n  }\n\n  set config(newConfig) {\n    CacheManager.defaultConfig = newConfig;\n  }\n\n  static entries: { [uri: string]: CacheEntry } = {};\n\n  static get(\n    source: string,\n    options: DownloadOptions,\n    cacheKey: string\n  ): CacheEntry {\n    if (!CacheManager.entries[cacheKey]) {\n      CacheManager.entries[cacheKey] = new CacheEntry(\n        source,\n        options,\n        cacheKey\n      );\n      return CacheManager.entries[cacheKey];\n    }\n    return CacheManager.entries[cacheKey];\n  }\n\n  static async clearCache(): Promise<void> {\n    const files = await FileSystem.ls(CacheManager.config.baseDir);\n    for (const file of files) {\n      try {\n        await FileSystem.unlink(`${CacheManager.config.baseDir}${file}`);\n      } catch (e) {\n        console.log(`error while clearing images cache, error: ${e}`);\n      }\n    }\n  }\n\n  static async removeCacheEntry(entry: string): Promise<void> {\n    try {\n      const file = await getCacheEntry(entry);\n      const { path } = file;\n      await FileSystem.unlink(path);\n    } catch (e) {\n      throw new Error('error while clearing image from cache');\n    }\n  }\n\n  static async getCacheSize(): Promise<number> {\n    const result = await FileSystem.stat(CacheManager.config.baseDir);\n    if (!result) {\n      throw new Error(`${CacheManager.config.baseDir} not found`);\n    }\n    return result.size;\n  }\n}\n\nconst getCacheEntry = async (\n  cacheKey: string\n): Promise<{ exists: boolean; path: string; tmpPath: string }> => {\n  const filename = cacheKey.substring(\n    cacheKey.lastIndexOf('/'),\n    cacheKey.indexOf('?') === -1 ? cacheKey.length : cacheKey.indexOf('?')\n  );\n  const ext =\n    filename.indexOf('.') === -1\n      ? '.jpg'\n      : filename.substring(filename.lastIndexOf('.'));\n  const sha = SHA1(cacheKey);\n  const path = `${CacheManager.config.baseDir}${sha}${ext}`;\n  const tmpPath = `${CacheManager.config.baseDir}${sha}-${uniqueId()}${ext}`;\n  // TODO: maybe we don't have to do this every time\n  try {\n    await FileSystem.mkdir(CacheManager.config.baseDir);\n  } catch (e) {\n    // do nothing\n  }\n  const exists = await FileSystem.exists(path);\n  return { exists, path, tmpPath };\n};\n"]}